<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Synchronizovan√Ω audio stream s PeerJS a playlistem</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f4f8;
    margin: 0; padding: 1rem;
  }
  #status {
    padding: 0.5rem;
    background: #ddd;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    height: 4em;
    overflow-y: auto;
  }
  button, input, select {
    margin: 0.3rem;
    padding: 0.5rem;
    font-size: 1rem;
    cursor: pointer; /* Zaji≈°tƒõn√≠, ≈æe tlaƒç√≠tka vypadaj√≠ klikatelnƒõ */
  }
  #playlist {
    margin-top: 1rem;
    border-collapse: collapse;
    width: 100%;
  }
  #playlist th, #playlist td {
    border: 1px solid #ccc;
    padding: 0.3rem 0.5rem;
  }
  #playlist tr.active {
    background: #cceeff;
    font-weight: bold;
  }
  #qrcode {
    margin: 1rem 0;
  }
  #unmuteBtn {
    display: none;
    background: #d9534f;
    color: white;
    border: none;
    cursor: pointer;
  }
  #reader {
    width: 300px;
    height: 300px;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

</head>
<body>

<h1>Synchronizovan√Ω audio stream s PeerJS a playlistem</h1>

<div id="status"></div>

<label for="roleSelect">Role:</label>
<select id="roleSelect">
  <option value="sender">Vys√≠laƒç</option>
  <option value="receiver">P≈ôij√≠maƒç</option>
</select>

<div id="senderUI" style="display:none;">
  <label for="senderPeerIdInput">Zadej Peer ID (unik√°tn√≠):</label>
  <input type="text" id="senderPeerIdInput" placeholder="Nap≈ô. mujVysilac123" />
  <button id="initPeerBtn">Inicializovat Vys√≠laƒç</button>
  <button id="addToPlaylistBtn" disabled>P≈ôidat audio soubor do playlistu</button>
  <input type="file" id="audioFileInput" accept="audio/*" multiple />
  <button id="startPlaylistBtn" disabled>Spustit playlist</button>

  <h3>Ovl√°d√°n√≠ vys√≠laƒçe</h3>
  <button id="prevBtnS" disabled>‚èÆÔ∏è P≈ôedchoz√≠</button>
  <button id="playBtnS" disabled>‚ñ∂Ô∏è P≈ôehr√°t</button>
  <button id="pauseBtnS" disabled>‚è∏Ô∏è Pauza</button>
  <button id="nextBtnS" disabled>‚è≠Ô∏è Dal≈°√≠</button>
  <button id="shuffleBtnS" disabled style="background-color: #f0ad4e;">üîÄ N√°hodnƒõ</button> <h2>Playlist</h2>
  <table id="playlist">
    <thead>
      <tr><th>#</th><th>N√°zev</th><th>URL / Soubor</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>QR k√≥d pro p≈ôipojen√≠ p≈ôij√≠maƒçe</h3>
  <div id="qrcode"></div>
  <button id="copyIdBtn" disabled>Zkop√≠rovat Peer ID</button>
</div>

<div id="receiverUI" style="display:none;">
  <label for="peerIdInput">Peer ID Vys√≠laƒçe:</label>
  <input type="text" id="peerIdInput" placeholder="Zadej Peer ID vys√≠laƒçe" />
  <button id="connectBtn">P≈ôipojit</button>
  <button id="scanQrBtn">Naskenovat QR k√≥d</button>
  <button id="pasteIdBtn">Vlo≈æit z clipboardu</button>

  <audio id="audioReceiver" controls></audio>
  <button id="unmuteBtn">Odblokovat zvuk</button>

  <h3>Ovl√°d√°n√≠ p≈ôij√≠maƒçe</h3>
  <button id="prevBtnR" disabled>‚èÆÔ∏è P≈ôedchoz√≠</button>
  <button id="playBtnR" disabled>‚ñ∂Ô∏è P≈ôehr√°t</button>
  <button id="pauseBtnR" disabled>‚è∏Ô∏è Pauza</button>
  <button id="nextBtnR" disabled>‚è≠Ô∏è Dal≈°√≠</button>

  <div id="reader"></div>
</div>

<audio id="audioSource" crossorigin="anonymous" style="display:none;"></audio>

<script>
(() => {
  // Konstanty
  const SENDER_ID_KEY = 'myapp_sender_id';
  const PLAYLIST_KEY = 'myapp_playlist';

  // PeerJS ICE servery - m≈Ø≈æe≈° si doplnit sv√© TURN
  const TURN_CREDENTIALS = {
    urls: "turn:turn.example.com:3478",
    username: "user",
    credential: "pass"
  };

  // Stav
  let playlist = [];
  let currentTrackIndex = -1;
  let isShuffling = false; // üî• NOV√Å PROMƒöNN√Å pro n√°hodn√© p≈ôehr√°v√°n√≠
  let peerJs = null;
  let conn = null; // DataConnection
  let mediaConn = null; // MediaConnection
  let audioStreamSource = null; 
  let html5QrCode = null;

  // DOM elementy
  const statusEl = document.getElementById('status');
  const roleSelect = document.getElementById('roleSelect');
  const senderUI = document.getElementById('senderUI');
  const receiverUI = document.getElementById('receiverUI');

  const senderPeerIdInput = document.getElementById('senderPeerIdInput');
  const initPeerBtn = document.getElementById('initPeerBtn');
  const addToPlaylistBtn = document.getElementById('addToPlaylistBtn');
  const audioFileInput = document.getElementById('audioFileInput');
  const startPlaylistBtn = document.getElementById('startPlaylistBtn');
  const playlistTbody = document.querySelector('#playlist tbody');
  const qrcodeContainer = document.getElementById('qrcode');
  const copyIdBtn = document.getElementById('copyIdBtn');
  
  // Ovl√°d√°n√≠ vys√≠laƒçe
  const prevBtnS = document.getElementById('prevBtnS');
  const playBtnS = document.getElementById('playBtnS');
  const pauseBtnS = document.getElementById('pauseBtnS');
  const nextBtnS = document.getElementById('nextBtnS');
  const shuffleBtnS = document.getElementById('shuffleBtnS'); // üî• NOV√ù ELEMENT

  const peerIdInput = document.getElementById('peerIdInput');
  const connectBtn = document.getElementById('connectBtn');
  const scanQrBtn = document.getElementById('scanQrBtn');
  const pasteIdBtn = document.getElementById('pasteIdBtn');
  const audioReceiver = document.getElementById('audioReceiver');
  const unmuteBtn = document.getElementById('unmuteBtn');

  // Ovl√°d√°n√≠ p≈ôij√≠maƒçe (remote)
  const prevBtnR = document.getElementById('prevBtnR');
  const playBtnR = document.getElementById('playBtnR');
  const pauseBtnR = document.getElementById('pauseBtnR');
  const nextBtnR = document.getElementById('nextBtnR');

  const audioSource = document.getElementById('audioSource');

  // Pomocn√© funkce
  function logStatus(msg) {
    const time = new Date().toLocaleTimeString();
    statusEl.innerHTML += `[${time}] ${msg}<br>`;
    statusEl.scrollTop = statusEl.scrollHeight;
    console.log(msg);
  }

  function savePlaylistToLocal() {
    const serializablePlaylist = playlist.map(item => ({
        name: item.name, 
        url: item.url
    })).filter(item => item.url);
    
    localStorage.setItem(PLAYLIST_KEY, JSON.stringify(serializablePlaylist));
  }

  function loadPlaylistFromLocal() {
    try {
      const data = localStorage.getItem(PLAYLIST_KEY);
      if (data) {
        playlist = JSON.parse(data).filter(item => item.url);
        updatePlaylistUI();
      }
    } catch(e) {
      console.warn('Chyba naƒç√≠t√°n√≠ playlistu z localStorage:', e);
    }
  }

  function updatePlaylistUI() {
    playlistTbody.innerHTML = '';
    playlist.forEach((item, i) => {
      const tr = document.createElement('tr');
      const sourceDisplay = item.file ? '[Lok√°ln√≠ soubor]' : item.url || 'Neplatn√Ω zdroj';
      
      tr.classList.toggle('active', i === currentTrackIndex);

      tr.appendChild(document.createElement('td')).textContent = (i + 1);
      tr.appendChild(document.createElement('td')).textContent = item.name || 'Untitled';
      tr.appendChild(document.createElement('td')).textContent = sourceDisplay;
      
      tr.onclick = () => {
          if (roleSelect.value === 'sender') {
              playTrack(i);
              startMediaStream(true); 
              sendTrackIndex(i, 0);
              sendControlMessage({ type: 'play' });
              updateSenderControls(true);
          }
      };

      playlistTbody.appendChild(tr);
    });
    
    updateSenderControls(false);
  }

  function showUI(role) {
    if (role === 'sender') {
      senderUI.style.display = 'block';
      receiverUI.style.display = 'none';
      unmuteBtn.style.display = 'none';
    } else {
      senderUI.style.display = 'none';
      receiverUI.style.display = 'block';
    }
  }

  function getIceConfig() {
    return {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        TURN_CREDENTIALS
      ]
    };
  }

  // --- Funkce pro Vys√≠laƒç (Sender) ---

  // Aktualizace ovl√°dac√≠ch tlaƒç√≠tek vys√≠laƒçe
  function updateSenderControls(isPlaying) {
      const isPeerInitialized = !!peerJs;
      const playlistLoaded = playlist.length > 0;
      const hasNext = currentTrackIndex + 1 < playlist.length;
      const hasPrev = currentTrackIndex > 0;
      
      startPlaylistBtn.disabled = !isPeerInitialized || !playlistLoaded || isPlaying;
      
      prevBtnS.disabled = !isPeerInitialized || !playlistLoaded || (!hasPrev && !isShuffling); // povoleno, pokud je shuffle
      playBtnS.disabled = !isPeerInitialized || !playlistLoaded || isPlaying;
      pauseBtnS.disabled = !isPeerInitialized || !playlistLoaded || !isPlaying;
      nextBtnS.disabled = !isPeerInitialized || !playlistLoaded || (!hasNext && !isShuffling); // povoleno, pokud je shuffle
      
      // Nastaven√≠ stylu pro shuffle
      shuffleBtnS.disabled = !isPeerInitialized || !playlistLoaded;
      shuffleBtnS.style.backgroundColor = isShuffling ? '#5cb85c' : '#f0ad4e'; // Zelen√° pro aktivn√≠ shuffle
      shuffleBtnS.style.color = isShuffling ? 'white' : 'black'; 
  }
  
  // Ovl√°d√°n√≠ vys√≠laƒçe
  prevBtnS.onclick = () => {
    if (isShuffling) {
        playNextRandomTrack();
    } else if (currentTrackIndex > 0) {
      playTrack(currentTrackIndex - 1, 0);
      startMediaStream(true);
      sendTrackIndex(currentTrackIndex, 0);
    }
    updateSenderControls(true);
  };
  
  playBtnS.onclick = () => {
    if (currentTrackIndex === -1) {
        // Pokud nic nehraje, spust√≠me prvn√≠ nebo n√°hodnou skladbu
        if (isShuffling) {
             playNextRandomTrack();
        } else {
             playTrack(0);
             sendTrackIndex(0, 0);
        }
    }
    
    audioSource.play().catch(e => logStatus('Chyba p≈ôehr√°v√°n√≠: ' + e.message));
    startMediaStream(true);
    sendControlMessage({ type: 'play' });
    updateSenderControls(true);
  };
  
  pauseBtnS.onclick = () => {
    stopMediaStream(); 
    sendControlMessage({ type: 'pause' });
    updateSenderControls(false);
  };
  
  nextBtnS.onclick = () => {
    if (isShuffling) {
        playNextRandomTrack();
    } else if (currentTrackIndex + 1 < playlist.length) {
      playTrack(currentTrackIndex + 1, 0);
      startMediaStream(true);
      sendTrackIndex(currentTrackIndex, 0);
    }
    updateSenderControls(true);
  };
  
  // üî• NOV√Å LOGIKA: Zapnut√≠/Vypnut√≠ n√°hodn√©ho p≈ôehr√°v√°n√≠
  shuffleBtnS.onclick = () => {
      isShuffling = !isShuffling;
      logStatus(`üîÄ N√°hodn√© p≈ôehr√°v√°n√≠ ${isShuffling ? 'zapnuto' : 'vypnuto'}.`);
      updateSenderControls(!audioSource.paused);
  };

  // üî• NOV√Å FUNKCE: Spu≈°tƒõn√≠ n√°hodn√© skladby
  function playNextRandomTrack() {
      if (playlist.length === 0) return;
      
      let nextIndex;
      do {
          nextIndex = Math.floor(Math.random() * playlist.length);
      } while (nextIndex === currentTrackIndex && playlist.length > 1); // Zaji≈°tƒõn√≠, ≈æe se neopakuje stejn√° skladba (pokud je v√≠c ne≈æ jedna)
      
      playTrack(nextIndex, 0);
      startMediaStream(true);
      sendTrackIndex(nextIndex, 0);
      updateSenderControls(true);
  }

  function playTrack(index, startTime = 0) {
    if (index < 0 || index >= playlist.length) return;

    currentTrackIndex = index;
    const track = playlist[index];
    
    audioSource.pause();
    
    let sourceUrl = '';
    if (track.url) {
        sourceUrl = track.url;
        audioSource.crossOrigin = 'anonymous';
        logStatus(`‚ñ∂Ô∏è P≈ôehr√°v√°m skladbu #${index + 1} (URL): ${track.name}`);
    } else if (track.file) {
        sourceUrl = URL.createObjectURL(track.file);
        audioSource.crossOrigin = null; 
        logStatus(`‚ñ∂Ô∏è P≈ôehr√°v√°m lok√°ln√≠ soubor #${index + 1}: ${track.name}`);
    } else {
        logStatus(`‚ùå Neplatn√Ω zdroj pro skladbu #${index + 1}.`);
        return;
    }

    audioSource.src = sourceUrl;
    audioSource.load();
    audioSource.currentTime = startTime;

    audioSource.play().catch(e => {
        logStatus('‚ùå Chyba p≈ôehr√°v√°n√≠ audioSource: ' + e.message);
    });

    updatePlaylistUI();
  }

  function startMediaStream(forceRestart = false) {
    if (!audioSource.src) return;
    
    if (mediaConn && !forceRestart) {
        logStatus('Stream ji≈æ bƒõ≈æ√≠. Opakov√°n√≠ hovoru zbyteƒçn√©.');
        return;
    }
    
    if (mediaConn) {
        mediaConn.close();
        mediaConn = null;
    }
    if (audioStreamSource) {
        audioStreamSource.getTracks().forEach(track => track.stop());
        audioStreamSource = null;
    }

    try {
        audioSource.play().catch(e => {
             logStatus('Upozornƒõn√≠: P≈ôehr√°v√°n√≠ audioSource zablokov√°no, stream nemus√≠ fungovat.');
        });

        audioStreamSource = audioSource.captureStream ? audioSource.captureStream() : audioSource.mozCaptureStream();
        
        if (!audioStreamSource) {
            logStatus('‚ùå Prohl√≠≈æeƒç nepodporuje captureStream/mozCaptureStream!');
            return;
        }

        if (conn && conn.open) {
          mediaConn = peerJs.call(conn.peer, audioStreamSource);
          mediaConn.on('close', () => {
            logStatus('Media stream ukonƒçen.');
          });
          mediaConn.on('error', err => {
            logStatus('Chyba media streamu: ' + err);
          });
          logStatus('üì° Media stream spu≈°tƒõn k p≈ô√≠jemci.');
        } else {
            logStatus('‚ùå Nelze spustit stream: P≈ôij√≠maƒç nen√≠ p≈ôipojen p≈ôes DataChannel.');
        }
    } catch (e) {
        logStatus('‚ùå Chyba p≈ôi z√≠sk√°v√°n√≠ streamu: ' + e.message);
    }
  }

  function stopMediaStream() {
    audioSource.pause(); 
    if (mediaConn) {
      mediaConn.close();
      mediaConn = null;
    }
    logStatus('Media stream a lok√°ln√≠ p≈ôehr√°v√°n√≠ zastaveno.');
  }

  function sendTrackIndex(index, currentTime = 0) {
    if (conn && conn.open) {
      conn.send({ type: 'playTrack', index, currentTime });
    }
  }

  function sendControlMessage(msg) {
    if (conn && conn.open) {
      conn.send(msg);
    }
  }

  function sendTimeSync(connection) {
    if (!connection || !connection.open) return;

    const syncInterval = setInterval(() => {
      if (!connection.open) {
        clearInterval(syncInterval);
        return;
      }
      if (!audioSource.paused) {
        connection.send({
          type: 'timeSync',
          senderTime: audioSource.currentTime
        });
      }
    }, 1000);

    connection.on('close', () => clearInterval(syncInterval));
  }
  
  // --- Konec funkc√≠ pro Vys√≠laƒç ---


  // --- Funkce pro P≈ôij√≠maƒç (Receiver) ---
  
  function updateReceiverControls(isPlaying) {
    // Ovl√°d√°n√≠ p≈ôij√≠maƒçe v Receiver m√≥du pouze odes√≠l√° p≈ô√≠kazy Vys√≠laƒçi
    const connected = !!conn;
    const hasAnyTrack = playlist.length > 0; 

    // P≈ôij√≠maƒç nem≈Ø≈æe vƒõdƒõt, jestli je shuffle aktivn√≠ na vys√≠laƒçi,
    // ale tlaƒç√≠tka pro NEXT/PREV mu povolit mus√≠me, pokud je p≈ôipojen
    prevBtnR.disabled = !connected || !hasAnyTrack;
    playBtnR.disabled = !connected || isPlaying;
    pauseBtnR.disabled = !connected || !isPlaying;
    nextBtnR.disabled = !connected || !hasAnyTrack;
  }
  
  // Ovl√°d√°n√≠ p≈ôij√≠maƒçe (odes√≠l√° p≈ô√≠kazy)
  prevBtnR.onclick = () => { if (conn) sendControlMessage({ type: 'prev' }); };
  playBtnR.onclick = () => { 
    if (conn) sendControlMessage({ type: 'play' });
    if (audioReceiver.srcObject) {
      audioReceiver.play().catch(e => {
        unmuteBtn.style.display = 'block';
        logStatus('P≈ôehr√°v√°n√≠ zablokov√°no. Mobiln√≠ interakce nutn√°!');
        updateReceiverControls(false);
      });
      updateReceiverControls(true);
    }
  };
  pauseBtnR.onclick = () => { if (conn) sendControlMessage({ type: 'pause' }); };
  nextBtnR.onclick = () => { if (conn) sendControlMessage({ type: 'next' }); };

  unmuteBtn.onclick = () => {
    if (audioReceiver.srcObject) {
      audioReceiver.play().then(() => {
        logStatus('Zvuk odblokov√°n u≈æivatelem.');
        unmuteBtn.style.display = 'none';
        updateReceiverControls(true);
      }).catch(e => {
        logStatus('Nelze odblokovat zvuk: ' + e.message);
      });
    }
  };
  
  function setRemoteTrackIndex(index, time) {
    if (index < 0 || index >= playlist.length) return;
    currentTrackIndex = index;
    logStatus(`P≈ôij√≠maƒç synchronizuje na skladbu #${index + 1}, ƒças ${time.toFixed(2)}s`);
    updatePlaylistUI();
  }

  function handleTimeSync(data) {
    if (audioReceiver.srcObject && !audioReceiver.paused) {
      const senderTime = data.senderTime;
      const receiverTime = audioReceiver.currentTime;
      const drift = receiverTime - senderTime;
      
      if (Math.abs(drift) > 0.5) {
        logStatus(`‚ö†Ô∏è Synchronizace: Odchylka ${drift.toFixed(2)}s. Opravuji ƒças.`);
        audioReceiver.currentTime = senderTime;
      } else {
        logStatus(`‚úÖ Synchronizace: Odchylka ${drift.toFixed(2)}s (v toleranci).`);
      }
    }
  }

  // --- Konec funkc√≠ pro P≈ôij√≠maƒç ---


  // --- Zpracov√°n√≠ zpr√°v a inicializace ---

  function handleDataMessage(data) {
    if (!data.type) return;
    
    const isSender = roleSelect.value === 'sender';

    switch (data.type) {
      case 'playTrack':
        if (isSender) {
           // Vys√≠laƒç obdr≈æ√≠ po≈æadavek na zmƒõnu skladby
           if (typeof data.index === 'number') {
              playTrack(data.index, data.currentTime || 0);
              startMediaStream(true); 
              sendTrackIndex(data.index, data.currentTime || 0); 
              updateSenderControls(true);
           }
        } else {
            // P≈ôij√≠maƒç obdr≈æ√≠ informaci o zmƒõnƒõ skladby
            setRemoteTrackIndex(data.index, data.currentTime || 0);
        }
        break;
      case 'play':
        if (isSender) {
          audioSource.play().catch(e => logStatus('Chyba p≈ôehr√°v√°n√≠: ' + e.message));
          startMediaStream(true);
          updateSenderControls(true);
        } else {
          if (audioReceiver.srcObject) {
             audioReceiver.play().catch(e => {
                unmuteBtn.style.display = 'block';
                logStatus('P≈ôehr√°v√°n√≠ zablokov√°no. Interakce nutn√°!');
             });
          }
          updateReceiverControls(true);
        }
        break;
      case 'pause':
        if (isSender) {
          stopMediaStream();
          updateSenderControls(false);
        } else {
          audioReceiver.pause();
          updateReceiverControls(false);
        }
        break;
      case 'prev':
      case 'next':
        if (isSender) {
          // Vys√≠laƒç obdr≈æ√≠ ≈ô√≠d√≠c√≠ sign√°l od p≈ô√≠jemce a provede akci
          if (data.type === 'next') {
              nextBtnS.click();
          } else {
              prevBtnS.click();
          }
        }
        break;
      case 'timeSync':
        if (!isSender) {
          handleTimeSync(data);
        }
        break;
    }
  }
  
  // --- Inicializace PeerJS pro vys√≠laƒç ---
  function startSender(peerId) {
    if (peerJs) {
      peerJs.destroy();
      peerJs = null;
    }

    peerJs = new Peer(peerId, { config: getIceConfig(), debug: 2, });

    peerJs.on('open', id => {
      logStatus(`‚úÖ Vys√≠laƒç inicializov√°n s ID: ${id}`);
      generateQrCode(id);
      copyIdBtn.disabled = false;
      addToPlaylistBtn.disabled = false;
      updateSenderControls(false);
    });

    peerJs.on('connection', connection => {
      logStatus(`P≈ôijato spojen√≠ od p≈ôij√≠maƒçe: ${connection.peer}`);

      if (conn) {
        conn.close();
      }
      conn = connection;

      conn.on('data', handleDataMessage);
      conn.on('close', () => {
        logStatus('Spojen√≠ s p≈ôij√≠maƒçem ukonƒçeno.');
        conn = null;
      });
      conn.on('error', err => {
        logStatus('Chyba spojen√≠: ' + err);
      });

      sendTimeSync(conn);
      
      if (!audioSource.paused && currentTrackIndex !== -1) {
         startMediaStream(true);
         sendTrackIndex(currentTrackIndex, audioSource.currentTime);
         sendControlMessage({ type: 'play' });
      }
    });

    peerJs.on('error', err => { logStatus('PeerJS chyba: ' + err); });
    
    // Auto-play next track (Sender only)
    audioSource.onended = () => {
        if (isShuffling) {
            playNextRandomTrack();
        } else if (currentTrackIndex + 1 < playlist.length) {
            playTrack(currentTrackIndex + 1, 0);
            startMediaStream(true);
            sendTrackIndex(currentTrackIndex, 0);
            updateSenderControls(true);
        } else {
            logStatus('Playlist dohr√°n');
            stopMediaStream();
            updateSenderControls(false);
        }
    };
  }

  // --- Inicializace p≈ôij√≠maƒçe (zde nen√≠ zmƒõna) ---
  function startReceiver() {
    if (peerJs) {
      peerJs.destroy();
      peerJs = null;
    }
    peerJs = new Peer({ config: getIceConfig(), debug: 2 });

    peerJs.on('open', id => { logStatus(`P≈ôij√≠maƒç p≈ôipraven s ID: ${id}`); });

    peerJs.on('call', mediaConnection => {
      logStatus(`P≈ôij√≠m√°m media stream od: ${mediaConnection.peer}`);
      if (mediaConn) { mediaConn.close(); }
      mediaConn = mediaConnection;

      mediaConn.on('stream', stream => {
        audioReceiver.srcObject = stream;
        audioReceiver.play().catch(() => {
          unmuteBtn.style.display = 'block';
          logStatus('Klikni na "Odblokovat zvuk" pro p≈ôehr√°n√≠.');
        });
        updateReceiverControls(true);
      });

      mediaConn.on('close', () => {
        logStatus('Media stream ukonƒçen.');
        audioReceiver.srcObject = null;
        updateReceiverControls(false);
      });

      mediaConn.on('error', err => { logStatus('Media stream chyba: ' + err); });
      mediaConn.answer(null);
    });

    connectBtn.onclick = () => {
      const targetId = peerIdInput.value.trim();
      if (!targetId) { alert('Zadej Peer ID vys√≠laƒçe'); return; }
      if (conn) { conn.close(); conn = null; }
      
      conn = peerJs.connect(targetId, { reliable: true, serialization: 'json' });

      conn.on('open', () => {
        logStatus(`P≈ôipojeno k vys√≠laƒçi: ${targetId}. Oƒçek√°v√°m media stream...`);
        updateReceiverControls(false);
        if (peerJs.open) {
          mediaConn = peerJs.call(targetId, null);
          mediaConn.on('error', err => logStatus('Media Call Error: ' + err));
        }
      });
      conn.on('data', handleDataMessage);
      conn.on('close', () => {
        logStatus('Spojen√≠ ukonƒçeno.');
        conn = null;
        updateReceiverControls(false);
        if (mediaConn) mediaConn.close();
      });
      conn.on('error', err => { logStatus('Chyba spojen√≠: ' + err); });
    };

    scanQrBtn.onclick = () => {
      if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => {
          html5QrCode = null; peerIdInput.value = ''; logStatus('Skener zastaven.'); document.getElementById('reader').innerHTML = '';
        }); return;
      }
      html5QrCode = new Html5Qrcode("reader");
      const config = { fps: 10, qrbox: 250 };
      html5QrCode.start(
        { facingMode: "environment" }, config, decodedText => {
          logStatus('QR k√≥d naskenov√°n: ' + decodedText);
          peerIdInput.value = decodedText;
          html5QrCode.stop().then(() => { html5QrCode = null; document.getElementById('reader').innerHTML = ''; connectBtn.click(); });
        }, errorMessage => {}
      ).catch(err => { logStatus('Chyba spu≈°tƒõn√≠ QR skeneru: ' + err); });
    };

    pasteIdBtn.onclick = () => {
      navigator.clipboard.readText()
        .then(text => {
          if (text) { peerIdInput.value = text.trim(); logStatus('Peer ID vlo≈æeno ze schr√°nky: ' + text); connectBtn.click();
          } else { logStatus('Schr√°nka je pr√°zdn√°.'); }
        })
        .catch(err => { logStatus('Nelze ƒç√≠st schr√°nku: ' + err); });
    };
  }
  
  function generateQrCode(peerId) {
    qrcodeContainer.innerHTML = '';
    new QRCode(qrcodeContainer, { text: peerId, width: 200, height: 200, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
  }

  copyIdBtn.onclick = () => {
    if (!senderPeerIdInput.value) return;
    navigator.clipboard.writeText(senderPeerIdInput.value)
      .then(() => logStatus('Peer ID zkop√≠rov√°no do schr√°nky.'))
      .catch(err => logStatus('Nelze kop√≠rovat: ' + err));
  };

  audioFileInput.addEventListener('change', event => {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    files.forEach(file => { playlist.push({ name: file.name, file }); });
    updatePlaylistUI();
    logStatus(`‚úÖ P≈ôid√°no ${files.length} audio soubor≈Ø do playlistu.`);
  });

  addToPlaylistBtn.onclick = () => { audioFileInput.click(); };

  startPlaylistBtn.onclick = () => {
    if (playlist.length === 0) { alert('Playlist je pr√°zdn√Ω!'); return; }
    currentTrackIndex = -1;
    playBtnS.click(); 
  };


  // --- Role selection a Inicializace p≈ôi startu ---
  roleSelect.addEventListener('change', () => {
    if (peerJs) { peerJs.destroy(); peerJs = null; }
    currentTrackIndex = -1;
    isShuffling = false; // Reset shuffle
    updatePlaylistUI();
    showUI(roleSelect.value);

    if (roleSelect.value === 'sender') {
      initPeerBtn.disabled = false;
      addToPlaylistBtn.disabled = true;
    } else {
      startReceiver();
    }
  });

  showUI(roleSelect.value);
  loadPlaylistFromLocal();

  if (roleSelect.value === 'sender') {
    initPeerBtn.disabled = false;
    addToPlaylistBtn.disabled = true;
    updateSenderControls(false);
  } else {
    startReceiver();
  }

  initPeerBtn.onclick = () => {
    const id = senderPeerIdInput.value.trim();
    if (!id) { alert('Zadej Peer ID pro vys√≠laƒç'); return; }
    startSender(id);
  };

})();
</script>

</body>
</html>
