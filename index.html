<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Audio stream + playlist p≈ôes WebRTC s PeerJS a synchronizac√≠</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #121212; color: #eee; }
  h1 { margin-bottom: 10px; }
  label[for="role"], #role { display: none; }
  button { padding: 10px 20px; background: #0b84ff; border: none; border-radius: 6px; color: white; cursor: pointer; margin-right: 5px; }
  button:disabled { background: #555; cursor: not-allowed; }
  #status { margin-top: 15px; font-weight: bold; min-height: 1.5em; color: #0b84ff; }
  #playlist { margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #555; padding: 5px; list-style-type: none; }
  #playlist li { cursor: pointer; padding: 5px; margin-bottom: 2px; border-radius: 4px; }
  #playlist li:hover { background: #333; }
  #playlist li.active { background: #0b84ff; font-weight: bold; }
  #controls { margin-top: 10px; }
  #peerIdInput, #senderPeerIdInput, #turnUrlInput, #turnUsernameInput, #turnCredentialInput, #streamUrlInput { 
    width: 300px; padding: 5px; margin-top: 10px; background: #222; border: 1px solid #444; color: #eee; border-radius: 4px; 
  }
  #unmuteBtn { background: #ff0b3c !important; display: none; margin: 15px auto; padding: 15px 30px; font-size: 1.2em; font-weight: bold; }
  #qrcodeContainer { background: white; padding: 10px; border-radius: 8px; display: inline-block; margin-top: 15px; }
  #peerIdDisplay { font-weight: bold; margin-bottom: 5px; color: #333; }
  #readerContainer { margin-top: 15px; display: flex; justify-content: center; }
  #pasteIdBtn, #copyIdBtn { margin-left: 10px; display: inline-block; }
  #controls button, #controlsReceiver button {
      padding: 8px 15px;
      margin-right: 8px;
      display: inline-block;
  }
  #senderUI, #receiverUI { margin-top: 20px; }
  /* üî• K√ìD Z VERZE 1: Odebr√°n 'playsinline', kter√Ω byl ve Verzi 2 a 3 */
  audio { margin-top: 10px; width: 100%; outline: none; border-radius: 6px; background: #222; }

</style>
</head>
<body>
  <h1>Audio stream + playlist p≈ôes WebRTC s PeerJS a synchronizac√≠</h1>

  <div id="roleSelector" style="margin-bottom: 20px;">
      <button id="setSenderBtn" style="background:#ff6600;">Vys√≠laƒç (Stream)</button>
      <button id="setReceiverBtn" style="background:#0b84ff;">P≈ôij√≠maƒç (Poslech)</button>
  </div>
  
  <label for="role" style="display:none;">Vyber roli:</label>
  <select id="role" style="display:none;">
    <option value="sender">Vys√≠laƒç (stream audio)</option>
    <option value="receiver">P≈ôij√≠maƒç (poslech)</option>
  </select>
  
  <div id="senderUI" style="display:none;">
    <h2>Vys√≠laƒç</h2>
    
    <input type="text" id="streamUrlInput" placeholder="Zadejte URL streamu (nap≈ô. http://icecast.com/stream.mp3)" 
           style="width: 300px; padding: 5px; margin-top: 10px; background: #222; border: 1px solid #444; color: #eee; border-radius: 4px; display: block;" />
    <button id="addUrlToPlaylistBtn">P≈ôidat URL do playlistu (Zkusit CORS Proxy)</button> 
    <hr style="border-color:#333; margin: 15px 0;">
    
    <input type="file" id="audioFileInput" accept="audio/*" multiple />
    <button id="addToPlaylistBtn" disabled>P≈ôidat soubor(y) do playlistu</button>
    
    <h3>Playlist</h3>
    <ul id="playlist"></ul>
    
    <button id="startPlaylistBtn" disabled style="background:#28a745;">Start p≈ôehr√°v√°n√≠ playlistu</button>
    <audio id="audioSource" controls></audio>
    <div id="controls" style="margin-top:5px;">
      <button id="prevBtn" disabled>‚èÆÔ∏è P≈ôedchoz√≠</button>
      <button id="playBtn" disabled>‚ñ∂Ô∏è Play</button>
      <button id="pauseBtn" disabled>‚è∏Ô∏è Pauza</button>
      <button id="nextBtn" disabled>‚è≠Ô∏è Dal≈°√≠</button>
    </div>
    
    <hr style="border-color:#333; margin: 15px 0;">
    <h3>Konfigurace TURN Serveru (Voliteln√©)</h3>
    <p style="font-size: 0.9em; margin-top: 0;">Zadejte vlastn√≠ TURN server pro robustn√≠ NAT traversal.</p>
    <input type="text" id="turnUrlInput" placeholder="TURN URL (nap≈ô. turn:vas.server.com:3478)" />
    <input type="text" id="turnUsernameInput" placeholder="TURN U≈æivatelsk√© jm√©no" />
    <input type="password" id="turnCredentialInput" placeholder="TURN Heslo/Kredenci√°l" />
    
    <p style="margin-top: 15px;">Peer ID: <input id="senderPeerIdInput" type="text" placeholder="Zadej vlastn√≠ Peer ID" /></p>
    <button id="initPeerBtn" style="background:#ff6600;">Inicializovat Peer (vys√≠laƒç)</button>
    
    <div id="qrcodeContainer" style="display:none;">
        <p id="peerIdDisplay"></p>
        <div id="qrcode"></div>
        <button id="copyIdBtn" style="margin-top: 10px; background: #28a745;">Kop√≠rovat ID</button>
    </div>
    </div>

  <div id="receiverUI" style="display:none;">
    <h2>P≈ôij√≠maƒç</h2>
    <input type="text" id="peerIdInput" placeholder="Zadej Peer ID vys√≠laƒçe" />
    <button id="connectBtn">P≈ôipojit</button>
    <button id="pasteIdBtn" style="margin-top: 15px; background: #007bff;">Vlo≈æit ID ze schr√°nky</button>
    
    <button id="scanQrBtn" style="margin-top: 15px;">Skenovat QR K√≥d</button>
    <div id="readerContainer">
        <div id="reader"></div>
    </div>
    <div id="autoplayBlocker" style="text-align: center;">
        <button id="unmuteBtn">KLIKNƒöTE PRO POVOLEN√ç ZVUKU</button>
    </div>
    
    <audio id="audioReceiver" controls autoplay></audio>
    <div id="controlsReceiver" style="margin-top:5px;">
      <button id="prevBtnR" disabled>‚èÆÔ∏è P≈ôedchoz√≠</button>
      <button id="playBtnR" disabled>‚ñ∂Ô∏è Play</button>
      <button id="pauseBtnR" disabled>‚è∏Ô∏è Pauza</button>
      <button id="nextBtnR" disabled>‚è≠Ô∏è Dal≈°√≠</button>
    </div>
  </div>

  <div id="status"></div>

  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    // --- KONSTANTY PRO LOCAL STORAGE ---
    const SENDER_ID_KEY = 'webrtc_sender_peer_id';
    const PLAYLIST_KEY = 'webrtc_playlist';
    // ----------------------------------

    const roleSelect = document.getElementById('role');
    const senderUI = document.getElementById('senderUI');
    const receiverUI = document.getElementById('receiverUI');
    const audioFileInput = document.getElementById('audioFileInput');
    const addToPlaylistBtn = document.getElementById('addToPlaylistBtn');
    const playlistEl = document.getElementById('playlist');
    const startPlaylistBtn = document.getElementById('startPlaylistBtn');
    const audioSource = document.getElementById('audioSource');
    const audioReceiver = document.getElementById('audioReceiver');
    const statusDiv = document.getElementById('status');
    const senderPeerIdInput = document.getElementById('senderPeerIdInput');
    const initPeerBtn = document.getElementById('initPeerBtn');
    const peerIdInput = document.getElementById('peerIdInput');
    const connectBtn = document.getElementById('connectBtn');
    
    const streamUrlInput = document.getElementById('streamUrlInput');
    const addUrlToPlaylistBtn = document.getElementById('addUrlToPlaylistBtn'); 
    const unmuteBtn = document.getElementById('unmuteBtn');
    const qrcodeContainer = document.getElementById('qrcodeContainer');
    const peerIdDisplay = document.getElementById('peerIdDisplay');
    const scanQrBtn = document.getElementById('scanQrBtn');
    const readerContainer = document.getElementById('readerContainer');
    const copyIdBtn = document.getElementById('copyIdBtn');
    const pasteIdBtn = document.getElementById('pasteIdBtn');
    let html5QrCode = null;
    
    const turnUrlInput = document.getElementById('turnUrlInput');
    const turnUsernameInput = document.getElementById('turnUsernameInput');
    const turnCredentialInput = document.getElementById('turnCredentialInput');
    
    const setSenderBtn = document.getElementById('setSenderBtn');
    const setReceiverBtn = document.getElementById('setReceiverBtn');

    const PROXIES = [
        'https://corsproxy.io/?',
        'https://api.allorigins.win/raw?url=',
        'https://thingproxy.freeboard.io/fetch/',
        'https://yacdn.org/proxy/',
        'https://cors-proxy.htmldriven.com/?url=',
        'https://jsonp.afeld.org/?url='
    ];

    const prevBtn = document.getElementById('prevBtn');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtnR = document.getElementById('prevBtnR');
    const playBtnR = document.getElementById('playBtnR');
    const pauseBtnR = document.getElementById('pauseBtnR');
    const nextBtnR = document.getElementById('nextBtnR');

    let peerJs = null;
    let conn = null; // DataConnection
    let mediaConn = null; // MediaConnection
    let audioStreamSource = null; // MediaStream z vys√≠laƒçe
    let audioContext = null; // Web Audio Context
    
    let sourceNode = null; 
    let destNode = null;   

    let playlist = [];
    let currentTrackIndex = -1;

    function getIceConfig() {
      const customUrl = turnUrlInput.value.trim();
      const customUsername = turnUsernameInput.value.trim();
      const customCredential = turnCredentialInput.value.trim();
      
      const iceServers = [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun.services.mozilla.com:3478' },
        { urls: 'stun:stun.stunprotocol.org' },
      ];
      
      if (customUrl && customUsername && customCredential) {
        logStatus('Pou≈æ√≠v√°m vlastn√≠ TURN server pro konfiguraci ICE.');
        iceServers.unshift({
          urls: customUrl,
          username: customUsername,
          credential: customCredential
        });
      }

      iceServers.push(
        { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:3478', username: 'openrelayproject', credential: 'openrelayproject' }
      );
      
      return { 
        iceServers: iceServers 
      };
    }
    
    const PEER_CONFIG = {
        host: '0.peerjs.com', 
        port: 443, 
        secure: true, 
        debug: 2 
    };

    function logStatus(msg) {
      statusDiv.innerHTML = msg; 
      console.log(msg.replace(/<[^>]*>?/gm, '')); 
    }
    
    function initAudioContext() {
        if (!audioContext) {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                logStatus('AudioContext inicializov√°n.');
            } catch (e) {
                logStatus('üõë Chyba inicializace AudioContext: ' + e.message);
                return false;
            }
        }
        
        if (audioContext.state === 'suspended') {
            audioContext.resume().catch(err => {
                logStatus('AudioContext.resume() selhalo: ' + err.message);
            });
        }
        return true;
    }
    
    function savePlaylistToLocal() {
        try {
            const serializablePlaylist = playlist.filter(track => !track.url.startsWith('blob:'));
            localStorage.setItem(PLAYLIST_KEY, JSON.stringify(serializablePlaylist));
            logStatus('Playlist ulo≈æen do lok√°ln√≠ho √∫lo≈æi≈°tƒõ.');
        } catch (e) {
            console.error('Chyba p≈ôi ukl√°d√°n√≠ playlistu:', e);
        }
    }

    function loadPlaylistFromLocal() {
        try {
            const storedPlaylist = localStorage.getItem(PLAYLIST_KEY);
            if (storedPlaylist) {
                playlist = JSON.parse(storedPlaylist);
                updatePlaylistUI();
            }
        } catch (e) {
            console.error('Chyba p≈ôi naƒç√≠t√°n√≠ playlistu:', e);
        }

        const storedSenderId = localStorage.getItem(SENDER_ID_KEY);
        if (storedSenderId) {
            senderPeerIdInput.value = storedSenderId;
        }
    }

    function showUI(role) {
      if (role === 'sender') {
        senderUI.style.display = 'block';
        receiverUI.style.display = 'none';
        unmuteBtn.style.display = 'none'; 
        qrcodeContainer.style.display = 'none';
        logStatus('Re≈æim Vys√≠laƒç. Inicializujte Peer ID.');
      } else {
        senderUI.style.display = 'none';
        receiverUI.style.display = 'block';
        logStatus('Re≈æim P≈ôij√≠maƒç. P≈ôipojte se k Vys√≠laƒçi.');
      }
    }
    
    function updatePlaylistUI() {
      playlistEl.innerHTML = '';
      playlist.forEach((track, i) => {
        const li = document.createElement('li');
        const displayUrl = track.url.startsWith('blob:') ? '[Lok√°ln√≠ Soubor]' : track.url.substring(0, 50) + (track.url.length > 50 ? '...' : '');
        li.textContent = `${i + 1}. ${track.name} (${displayUrl})`;
        if (i === currentTrackIndex) li.classList.add('active');
        li.onclick = () => {
          if (roleSelect.value === 'sender') {
            if (!initAudioContext()) return;
            stopMediaStream(false); 
            playTrack(i);
            sendTrackIndex(i, 0);
            startMediaStream(); 
            updateSenderControls(true);
          }
        };
        playlistEl.appendChild(li);
      });
      
      const enabled = playlist.length > 0 && !!peerJs && peerJs.open;
      startPlaylistBtn.disabled = !enabled;
      updateSenderControls(!audioSource.paused); 
    }

    function updateSenderControls(isPlaying) {
      const enabled = playlist.length > 0 && !!peerJs && peerJs.open;
      const hasNext = currentTrackIndex + 1 < playlist.length;
      const hasPrev = currentTrackIndex > 0;

      prevBtn.disabled = !enabled || !hasPrev;
      playBtn.disabled = !enabled || isPlaying;
      pauseBtn.disabled = !enabled || !isPlaying;
      nextBtn.disabled = !enabled || !hasNext;
      startPlaylistBtn.disabled = !enabled || isPlaying;
    }

    function playTrack(index, currentTime = 0) {
      if (index < 0 || index >= playlist.length) return;
      currentTrackIndex = index;
      const track = playlist[index];
      
      audioSource.crossOrigin = track.url.startsWith('blob:') ? null : "anonymous"; 
      
      audioSource.src = track.url;
      audioSource.currentTime = currentTime;
      
      audioSource.pause();
      audioSource.load();
      
      updatePlaylistUI();
      logStatus(`‚ñ∂Ô∏è Nastavena skladba #${index + 1}: ${track.name}`);
    }

    function setRemoteTrackIndex(index, currentTime = 0) {
      if (index < 0 || index >= playlist.length) return;
      currentTrackIndex = index;
      
      updatePlaylistUI();
      logStatus(`P≈ôij√≠maƒç synchronizuje na skladbu #${index + 1}`);

      if (audioReceiver.srcObject) {
         audioReceiver.currentTime = currentTime; 
      }
      
      if (audioReceiver.paused) {
          audioReceiver.play().catch(() => {});
      }
      updateReceiverControls(!audioReceiver.paused); 
    }

    function modifySdpForOpus96(sdp) {
      return sdp.replace(/a=fmtp:111 minptime=10;useinbandfec=1/g,
        'a=fmtp:111 minptime=10;useinbandfec=1;maxaveragebitrate=96000;stereo=1');
    }

    // üî• Z√ÅKLAD Z VERZE 1 (FUNKƒåN√ç) + P≈òID√ÅNO Media Session API Z VERZE 2
    function startMediaStream() {
        if (!conn || !conn.open) {
          logStatus('Nelze streamovat, p≈ô√≠jemce nen√≠ p≈ôipojen (DataChannel). ‚úÖ ƒåek√°m na p≈ôipojen√≠...');
          updateSenderControls(false);
          return;
        }
        if (!audioSource.src) {
          logStatus('Nelze streamovat, nen√≠ vybr√°na ≈æ√°dn√° skladba.');
          updateSenderControls(false);
          return;
        }

        try {
            // 1. KONTROLA a Probuzen√≠ AudioContext (K√≥d z Verze 1)
            if (!initAudioContext()) return;
            
            if (audioContext.state !== 'running') {
                audioContext.resume().catch(err => {
                    logStatus('AudioContext.resume() selhalo: ' + err.message);
                });
            }
            
            if (audioContext.state !== 'running') {
                logStatus(`üõë Chyba: AudioContext je ${audioContext.state}. Streamov√°n√≠ sel≈æe. Zkuste kliknout Play na stranƒõ Vys√≠laƒçe.`);
                audioSource.pause();
                updateSenderControls(false);
                return;
            }

            // 2. Lok√°ln√≠ p≈ôehr√°v√°n√≠ (K√≥d z Verze 1)
            audioSource.pause(); 
            
            audioSource.play().catch(err => {
              logStatus('üõë Lok√°ln√≠ p≈ôehr√°v√°n√≠ audio zablokov√°no. ' + err.message);
              updateSenderControls(false);
              return;
            });

            // 3. Spr√°va Web Audio uzl≈Ø (K√≥d z Verze 1)
            if (sourceNode) sourceNode.disconnect();
            if (destNode) destNode.disconnect();

            sourceNode = audioContext.createMediaElementSource(audioSource);
            destNode = audioContext.createMediaStreamDestination();

            sourceNode.connect(destNode);
            sourceNode.connect(audioContext.destination); 

            audioStreamSource = destNode.stream;

            // 4. Spu≈°tƒõn√≠ PeerJS hovoru (MediaCall) (K√≥d z Verze 1)
            if (mediaConn) {
               mediaConn.close();
               mediaConn = null;
            }
            mediaConn = peerJs.call(conn.peer, audioStreamSource, { metadata: { type: 'audioStream' } });

            // 5. SDP √∫prava (K√≥d z Verze 1)
            mediaConn.on('negotiationneeded', () => {
              const pc = mediaConn.peerConnection;
              if (pc) {
                const originalCreateOffer = pc.createOffer.bind(pc);
                pc.createOffer = function() {
                  return originalCreateOffer().then(offer => {
                    offer.sdp = modifySdpForOpus96(offer.sdp);
                    return offer;
                  });
                };
              }
            });

            mediaConn.on('close', stopMediaStream);
            mediaConn.on('error', err => {
              logStatus('Chyba Media Streamu: ' + err);
              stopMediaStream();
            });

            // üî• NOV√â (Z VERZE 2): Media Session API pro Vys√≠laƒç
            if ('mediaSession' in navigator) {
                const currentTrack = playlist[currentTrackIndex];
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: currentTrack ? currentTrack.name : 'Streamov√°n√≠...',
                    artist: 'WebRTC Vys√≠laƒç',
                    album: 'PeerJS Audio Stream',
                });

                // Nastaven√≠ akƒçn√≠ch handler≈Ø pro ovl√°d√°n√≠ z pozad√≠/notifikace
                navigator.mediaSession.setActionHandler('play', () => { startMediaStream(); });
                navigator.mediaSession.setActionHandler('pause', () => { stopMediaStream(); });
                navigator.mediaSession.setActionHandler('nexttrack', () => { 
                    if (currentTrackIndex + 1 < playlist.length) {
                        // Pou≈æ√≠v√°me .click() pro spu≈°tƒõn√≠ pln√© logiky (vƒçetnƒõ odesl√°n√≠ zpr√°vy)
                        nextBtn.click(); 
                    }
                });
                navigator.mediaSession.setActionHandler('previoustrack', () => { 
                     if (currentTrackIndex > 0) {
                        prevBtn.click();
                    }
                });
            }
            
            // 6. Odesl√°n√≠ ≈ô√≠d√≠c√≠ zpr√°vy (K√≥d z Verze 1)
            sendControlMessage({ type: 'play', currentTime: audioSource.currentTime });
            logStatus('‚úÖ Media stream zah√°jen k p≈ô√≠jemci.');
            updateSenderControls(true);
          } catch (e) {
            logStatus('Chyba p≈ôi startu Web Audio API/Media: ' + e.message);
            audioSource.pause();
            stopMediaStream(false);
          }
    }

    // üî• Z√ÅKLAD Z VERZE 1 (FUNKƒåN√ç) + P≈òID√ÅNO Media Session API Z VERZE 2
    function stopMediaStream(sendControl = true) {
      audioSource.pause();
      
      if (sourceNode) sourceNode.disconnect();
      if (destNode) destNode.disconnect();
      sourceNode = null;
      destNode = null;

      if (mediaConn) {
        if (audioStreamSource) {
            audioStreamSource.getTracks().forEach(track => track.stop());
            audioStreamSource = null;
        }
        mediaConn.close();
        mediaConn = null;
      }

      // üî• NOV√â (Z VERZE 2): Aktualizace Media Session stavu na pauzu
      if ('mediaSession' in navigator) {
          navigator.mediaSession.playbackState = 'paused';
      }

      if (sendControl && conn && conn.open) {
        sendControlMessage({ type: 'pause', currentTime: audioSource.currentTime });
      }
      logStatus('Media stream a lok√°ln√≠ p≈ôehr√°v√°n√≠ zastaveno.');
      updateSenderControls(false);
    }

    // üî• Z√ÅKLAD Z VERZE 1 (FUNKƒåN√ç) + P≈òID√ÅNO Media Session API Z VERZE 2
    audioSource.onended = () => {
      stopMediaStream(false);
      if (currentTrackIndex + 1 < playlist.length) {
        playTrack(currentTrackIndex + 1, 0);
        startMediaStream();
        sendTrackIndex(currentTrackIndex, 0);
      } else {
        logStatus('Playlist dohr√°n');
        // üî• NOV√â (Z VERZE 2): Nastaven√≠ Media Session na none, kdy≈æ je konec
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = null;
            navigator.mediaSession.playbackState = 'none';
        }
      }
    };

    audioFileInput.addEventListener('change', () => {
      addToPlaylistBtn.disabled = audioFileInput.files.length === 0;
    });

    addToPlaylistBtn.addEventListener('click', () => {
      const files = audioFileInput.files;
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const url = URL.createObjectURL(file);
        playlist.push({ name: file.name, url });
      }
      streamUrlInput.value = ''; 
      updatePlaylistUI();
      savePlaylistToLocal();
      addToPlaylistBtn.disabled = true;
      audioFileInput.value = '';
    });

    startPlaylistBtn.addEventListener('click', () => {
      if (!initAudioContext()) return;
      
      if (playlist.length > 0) {
        if (currentTrackIndex === -1 || audioSource.paused) { 
            playTrack(0, 0);
            sendTrackIndex(0, 0);
        }
        startMediaStream();
      }
    });

    function sendTrackIndex(index, currentTime = 0) {
      if (conn && conn.open) {
        conn.send({ type: 'playTrack', index, currentTime });
      }
    }

    function sendControlMessage(msg) {
      if (conn && conn.open) {
        conn.send(msg);
      }
    }

    function sendTimeSync(connection) {
        if (!connection || !connection.open) return;
        
        const syncInterval = setInterval(() => {
            if (!connection.open) {
                clearInterval(syncInterval);
                return;
            }
            if (!audioSource.paused) {
                connection.send({ 
                    type: 'timeSync', 
                    senderTime: audioSource.currentTime 
                });
            }
        }, 1000); 
        
        connection.on('close', () => clearInterval(syncInterval));
    }

    function handleTimeSync(data) {
        if (audioReceiver.srcObject && !audioReceiver.paused) {
            const senderTime = data.senderTime;
            const receiverTime = audioReceiver.currentTime;
            const drift = receiverTime - senderTime; 
            const driftFormatted = drift.toFixed(2);
            
            if (Math.abs(drift) > 0.5) { 
                logStatus(`‚ö†Ô∏è Synchronizace: Odchylka ${driftFormatted}s. Opravuji ƒças.`);
                audioReceiver.currentTime = senderTime; 
            } else {
                logStatus(`‚úÖ Synchronizace: Odchylka ${driftFormatted}s (v toleranci).`);
            }
        }
    }

    // üî• Z√ÅKLAD Z VERZE 1 (FUNKƒåN√ç) + P≈òID√ÅNO Media Session API Z VERZE 2
    function handleDataMessage(data) {
      if (!data.type) return;

      switch(data.type) {
        case 'playTrack':
          if (typeof data.index === 'number') {
            setRemoteTrackIndex(data.index, data.currentTime || 0);
          }
          break;
        case 'play':
          if (roleSelect.value === 'receiver' && audioReceiver.srcObject) {
            audioReceiver.play().catch(e => {
              unmuteBtn.style.display = 'block'; 
              logStatus('P≈ôehr√°v√°n√≠ zablokov√°no. Kliknƒõte pro povolen√≠ zvuku!');
              updateReceiverControls(false);
            });
            updateReceiverControls(true);

            // üî• NOV√â (Z VERZE 2): Aktualizace Media Session na Receiveru
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = 'playing';
            }

          } else if (roleSelect.value === 'sender') {
             startMediaStream();
          }
          break;
        case 'pause':
          if (roleSelect.value === 'receiver') {
            audioReceiver.pause();
            updateReceiverControls(false);
            
            // üî• NOV√â (Z VERZE 2): Aktualizace Media Session na Receiveru
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = 'paused';
            }

          } else if (roleSelect.value === 'sender') {
            stopMediaStream();
          }
          break;
        case 'prev':
          if (roleSelect.value === 'sender') {
            if (currentTrackIndex > 0) {
              stopMediaStream();
              playTrack(currentTrackIndex - 1, 0);
              startMediaStream();
              sendTrackIndex(currentTrackIndex, 0); 
            } else {
              logStatus('Nelze p≈ôeskoƒçit: Prvn√≠ skladba v playlistu.');
            }
          }
          break;
        case 'next':
          if (roleSelect.value === 'sender') {
            if (currentTrackIndex + 1 < playlist.length) {
              stopMediaStream();
              playTrack(currentTrackIndex + 1, 0);
              startMediaStream();
              sendTrackIndex(currentTrackIndex, 0); 
            } else {
              logStatus('Nelze p≈ôeskoƒçit: Posledn√≠ skladba v playlistu.');
            }
          }
          break;
        case 'timeSync': 
          if (roleSelect.value === 'receiver') {
            handleTimeSync(data);
          }
          break;
      }
    }

    // --- Ovl√°d√°n√≠ Vys√≠laƒçe (Lok√°ln√≠) ---
    // üî• PONECH√ÅNA P≈ÆVODN√ç LOGIKA Z VERZE 1 (kter√° vol√° stopMediaStream() s defaultn√≠m true)
    prevBtn.onclick = () => {
      if (!initAudioContext()) return;
      if (currentTrackIndex > 0) {
        stopMediaStream(); // <-- Z Verze 1
        playTrack(currentTrackIndex - 1, 0);
        startMediaStream();
        sendTrackIndex(currentTrackIndex, 0);
      }
    };
    playBtn.onclick = () => {
      if (!initAudioContext()) return;
      if (currentTrackIndex === -1 && playlist.length > 0) {
        playTrack(0, 0);
        sendTrackIndex(0, 0);
      }
      startMediaStream();
    };
    pauseBtn.onclick = () => {
      stopMediaStream();
    };
    nextBtn.onclick = () => {
      if (!initAudioContext()) return;
      if (currentTrackIndex + 1 < playlist.length) {
        stopMediaStream(); // <-- Z Verze 1
        playTrack(currentTrackIndex + 1, 0);
        startMediaStream();
        sendTrackIndex(currentTrackIndex, 0);
      }
    };

    // --- Ovl√°d√°n√≠ P≈ôij√≠maƒçe (Remote) ---
    prevBtnR.onclick = () => {
      if (conn && conn.open) { 
        sendControlMessage({ type: 'prev' });
      } else {
        logStatus('‚ùå Nelze odeslat P≈òEDCHOZ√ç: P≈ôij√≠maƒç nen√≠ p≈ôipojen.');
      }
    };
    playBtnR.onclick = () => {
      if (conn && conn.open) { 
        sendControlMessage({ type: 'play' }); 
      }
      if (audioReceiver.srcObject) {
          audioReceiver.play().catch(e => {
              unmuteBtn.style.display = 'block'; 
              logStatus('P≈ôehr√°v√°n√≠ zablokov√°no. Mobiln√≠ interakce nutn√°!');
              updateReceiverControls(false);
          });
      }
    };
    pauseBtnR.onclick = () => {
      if (conn && conn.open) { 
        sendControlMessage({ type: 'pause' });
      } else {
        logStatus('‚ùå Nelze odeslat PAUZA: P≈ôij√≠maƒç nen√≠ p≈ôipojen.');
      }
    };
    nextBtnR.onclick = () => {
      if (conn && conn.open) { 
        sendControlMessage({ type: 'next' });
      } else {
        logStatus('‚ùå Nelze odeslat DAL≈†√ç: P≈ôij√≠maƒç nen√≠ p≈ôipojen.');
      }
    };

    function updateReceiverControls(isPlaying) {
      const connected = !!conn;
      const hasNext = currentTrackIndex + 1 < playlist.length;
      const hasPrev = currentTrackIndex > 0;
      
      prevBtnR.disabled = !connected; 
      playBtnR.disabled = !connected || isPlaying;
      pauseBtnR.disabled = !connected || !isPlaying;
      nextBtnR.disabled = !connected;
    }
    
    unmuteBtn.onclick = () => {
        if (audioReceiver.srcObject) {
            audioReceiver.play().then(() => {
                logStatus('Zvuk odblokov√°n u≈æivatelsk√Ωm gestem.');
                unmuteBtn.style.display = 'none'; 
                if (conn) sendControlMessage({ type: 'play' }); 
            }).catch(e => {
                 logStatus('Odblokov√°n√≠ selhalo: ' + e.message);
            });
        }
    };

    function startSender(peerId) {
      if (peerJs) { peerJs.destroy(); peerJs = null; }
      
      qrcodeContainer.style.display = 'none';
      const qrcodeEl = document.getElementById('qrcode');
      qrcodeEl.innerHTML = '';

      const currentIceConfig = getIceConfig(); 
      
      logStatus('P≈ôipojuji se k PeerJS serveru (Vys√≠laƒç) p≈ôes WSS...');
      
      const configWithIce = { ...PEER_CONFIG, config: currentIceConfig };
      peerJs = new Peer(peerId, configWithIce); 

      peerJs.on('open', id => {
        logStatus(`‚úÖ Vys√≠laƒç Peer ID: ${id} p≈ôipojen. ƒåek√°m na p≈ô√≠jemce...`);
        
        new QRCode(qrcodeEl, { text: id, width: 180, height: 180, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
        peerIdDisplay.textContent = `Naskenujte k√≥d: ${id}`;
        qrcodeContainer.style.display = 'block';
        
        copyIdBtn.onclick = () => {
            navigator.clipboard.writeText(id).then(() => { logStatus('‚úÖ Peer ID zkop√≠rov√°no do schr√°nky!'); }).catch(err => { logStatus('üõë Nepoda≈ôilo se zkop√≠rovat ID: ' + err); });
        };
        
        initPeerBtn.disabled = true;
        addToPlaylistBtn.disabled = false;
        updatePlaylistUI();
      });

      peerJs.on('error', err => {
        logStatus(`‚ùå Chyba PeerJS (Vys√≠laƒç): ${err.message}. Zkuste obnovit str√°nku.`);
        initPeerBtn.disabled = false;
        qrcodeContainer.style.display = 'none';
      });

      peerJs.on('connection', connection => {
        if (conn) { conn.close(); } 
        conn = connection;
        conn.on('open', () => { 
          logStatus('P≈ôij√≠maƒç p≈ôipojen (DataChannel). Zahajuji synchronizaci...');
          sendTimeSync(conn);
          if (currentTrackIndex > -1) {
              sendTrackIndex(currentTrackIndex, audioSource.currentTime);
          }
        });

        conn.on('data', handleDataMessage);
        conn.on('close', () => {
          logStatus('P≈ôij√≠maƒç odpojen. ‚úÖ ƒåek√°m na dal≈°√≠ho p≈ô√≠jemce...');
          conn = null;
          if (mediaConn) mediaConn.close();
          mediaConn = null;
          qrcodeContainer.style.display = 'block'; 
        });
        conn.on('error', err => { logStatus('Chyba spojen√≠: ' + err); console.error(err); });
      });

      peerJs.on('call', call => {
        logStatus('Ignorov√°n p≈ô√≠choz√≠ hovor.');
        call.answer();
        call.close();
      });
    }

    // üî• Z√ÅKLAD Z VERZE 1 (FUNKƒåN√ç) + P≈òID√ÅNO Media Session API Z VERZE 2
    function startReceiver() {
      if (peerJs) { peerJs.destroy(); peerJs = null; }
      
      if (html5QrCode && html5QrCode.isScanning) {
          html5QrCode.stop().catch(err => console.log("Chyba p≈ôi zastavov√°n√≠ skeneru", err));
      }
      readerContainer.innerHTML = '<div id="reader"></div>';
      
      const currentIceConfig = getIceConfig(); 

      logStatus('P≈ôipojuji se k PeerJS serveru (P≈ôij√≠maƒç) p≈ôes WSS...');

      const configWithIce = { ...PEER_CONFIG, config: currentIceConfig };
      peerJs = new Peer(configWithIce); 

      peerJs.on('open', id => {
        logStatus(`‚úÖ P≈ôij√≠maƒç Peer ID: ${id} p≈ôipojen.`);
        updateReceiverControls(false);
        if (peerIdInput.value.trim()) {
             connectBtn.click();
        }
      });

      peerJs.on('error', err => {
        logStatus(`‚ùå Chyba PeerJS p≈ôij√≠maƒçe: ${err.message}. Zkuste obnovit str√°nku.`);
      });

      peerJs.on('call', call => {
        if (mediaConn) mediaConn.close();
        call.answer(null);
        mediaConn = call;

        call.on('stream', remoteStream => {
          logStatus('P≈ôijat Audio stream!');
          audioReceiver.srcObject = remoteStream;
          unmuteBtn.style.display = 'none'; 

          audioReceiver.play().catch(e => {
            unmuteBtn.style.display = 'block'; 
            logStatus('P≈ôehr√°v√°n√≠ zablokov√°no. Kliknƒõte pro povolen√≠ zvuku!');
            updateReceiverControls(false);
          });
          updateReceiverControls(true);
          
          // üî• NOV√â (Z VERZE 2): Media Session API pro P≈ôij√≠maƒç
          if ('mediaSession' in navigator) {
              navigator.mediaSession.metadata = new MediaMetadata({
                  title: 'WebRTC Audio Stream',
                  artist: 'P≈ôij√≠m√°no z Vys√≠laƒçe',
                  album: 'PeerJS Audio Stream'
              });

              navigator.mediaSession.setActionHandler('play', () => { sendControlMessage({ type: 'play' }); audioReceiver.play().catch(e => {}); });
              navigator.mediaSession.setActionHandler('pause', () => { sendControlMessage({ type: 'pause' }); audioReceiver.pause(); });
              navigator.mediaSession.setActionHandler('nexttrack', () => { sendControlMessage({ type: 'next' }); });
              navigator.mediaSession.setActionHandler('previoustrack', () => { sendControlMessage({ type: 'prev' }); });
              
              navigator.mediaSession.playbackState = 'playing';
          }
        });

        call.on('close', () => {
          logStatus('Stream ukonƒçen vys√≠laƒçem.');
          audioReceiver.srcObject = null;
          mediaConn = null;
          unmuteBtn.style.display = 'none';
          updateReceiverControls(false);

          // üî• NOV√â (Z VERZE 2): Vyƒçi≈°tƒõn√≠ Media Session
          if ('mediaSession' in navigator) {
              navigator.mediaSession.metadata = null;
              navigator.mediaSession.playbackState = 'none';
          }
        });

        call.on('error', err => { logStatus('Chyba streamu: ' + err); audioReceiver.srcObject = null; mediaConn = null; unmuteBtn.style.display = 'none'; updateReceiverControls(false); });
      });

      connectBtn.onclick = () => {
        if (!peerJs || !peerJs.open) { logStatus('Nelze nav√°zat spojen√≠, PeerJS nen√≠ inicializov√°n/otev≈ôen.'); return; }
        if (conn) { conn.close(); conn = null; }
        const senderId = peerIdInput.value.trim();
        if (!senderId) { alert('Zadej Peer ID vys√≠laƒçe'); return; }
        
        conn = peerJs.connect(senderId, { reliable: true, serialization: 'json' }); 

        conn.on('open', () => { logStatus('P≈ôipojeno k vys√≠laƒçi (DataChannel).'); updateReceiverControls(true); });
        conn.on('data', handleDataMessage);
        conn.on('close', () => { logStatus('Spojen√≠ ukonƒçeno.'); conn = null; updateReceiverControls(false); if (mediaConn) mediaConn.close(); });
        conn.on('error', err => { logStatus('Chyba spojen√≠: ' + err); console.error(err); });
      };
    }

    scanQrBtn.onclick = () => {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().then(() => { readerContainer.innerHTML = '<div id="reader"></div>'; }).catch(err => console.error("Chyba p≈ôi zastavov√°n√≠ skeneru", err));
            return;
        }

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        html5QrCode = new Html5Qrcode("reader");
        
        logStatus('Spou≈°t√≠m skener. Povolte p≈ô√≠stup ke kame≈ôe...');

        html5QrCode.start({ facingMode: "environment" }, config, 
            (decodedText) => {
                peerIdInput.value = decodedText;
                logStatus(`QR k√≥d naskenov√°n: ${decodedText}`);
                
                html5QrCode.stop().then(() => {
                    readerContainer.innerHTML = '<div id="reader"></div>';
                    html5QrCode = null;
                    connectBtn.click(); 
                }).catch(err => console.error("Chyba p≈ôi zastavov√°n√≠ skeneru", err));
            },
            (errorMessage) => {})
        .catch(err => { logStatus("üõë Chyba spu≈°tƒõn√≠ skeneru. Povolte p≈ô√≠stup ke kame≈ôe."); readerContainer.innerHTML = '<div id="reader"></div>'; html5QrCode = null; });
    };
    
    pasteIdBtn.onclick = () => {
        navigator.clipboard.readText().then(text => {
            if (text) {
                peerIdInput.value = text.trim();
                logStatus('‚úÖ Peer ID vlo≈æeno ze schr√°nky. Zkus√≠m p≈ôipojen√≠...');
                connectBtn.click();
            } else { logStatus('üõë Schr√°nka je pr√°zdn√° nebo neobsahuje text.'); }
        }).catch(err => { logStatus('üõë Nelze p≈ôistoupit ke schr√°nce. Povolte p≈ô√≠stup.'); console.error('Chyba ƒçten√≠ schr√°nky:', err); });
    };

    // üî• Z√ÅKLAD Z VERZE 1 (FUNKƒåN√ç) + P≈òID√ÅNO Media Session API Z VERZE 2
    function switchRole(newRole) {
        if (peerJs) { peerJs.destroy(); peerJs = null; }
        stopMediaStream(false); 
        playlist = [];
        currentTrackIndex = -1;
        updatePlaylistUI();
        
        // üî• NOV√â (Z VERZE 2): Zru≈°en√≠ Media Session p≈ôi p≈ôep√≠n√°n√≠ rol√≠
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = null;
            navigator.mediaSession.playbackState = 'none';
        }
        
        roleSelect.value = newRole; 
        showUI(newRole);

        if (newRole === 'sender') {
          initPeerBtn.disabled = false;
          addToPlaylistBtn.disabled = true;
          logStatus('P≈ôepnuto na re≈æim Vys√≠laƒç. Inicializujte Peer ID.');
        } else {
          startReceiver();
          logStatus('P≈ôepnuto na re≈æim P≈ôij√≠maƒç. Zadejte nebo naskenujte Peer ID Vys√≠laƒçe.');
        }
    }

    setSenderBtn.onclick = () => switchRole('sender');
    setReceiverBtn.onclick = () => switchRole('receiver');

    function autoInitRole() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlRole = urlParams.get('role');
        
        let targetRole = 'receiver'; 
        if (urlRole === 'sender') {
            targetRole = 'sender';
        }

        logStatus(`Automaticky vybr√°na role: ${targetRole.toUpperCase()}`);
        
        switchRole(targetRole); 
        
        if (targetRole === 'receiver') {
            const peerIdParam = urlParams.get('peer');
            if (peerIdParam) {
                peerIdInput.value = peerIdParam.trim();
                logStatus(`Nalezeno Peer ID v URL: ${peerIdParam}. Automaticky se p≈ôipojuji...`);
                
                setTimeout(() => {
                    if (peerJs && peerJs.open) {
                        connectBtn.click();
                    } else {
                        peerJs.on('open', () => { connectBtn.click(); });
                    }
                }, 500); 
            }
        }
    }
    
    loadPlaylistFromLocal();
    autoInitRole(); 


    initPeerBtn.onclick = () => {
      const peerId = senderPeerIdInput.value.trim();
      if (!peerId) { alert('Zadej vlastn√≠ Peer ID pro vys√≠laƒç'); return; }
      localStorage.setItem(SENDER_ID_KEY, peerId); 
      startSender(peerId);
    };
    
    addUrlToPlaylistBtn.addEventListener('click', async () => {
        const originalUrl = streamUrlInput.value.trim();
        if (!originalUrl) { logStatus('Zadejte URL streamu (nap≈ô. Icecast).'); return; }
        
        logStatus('Zkou≈°√≠m naƒç√≠st URL stream a proxy. M≈Ø≈æe trvat a≈æ 8s...');
        
        const isEncoded = originalUrl.includes('%');
        let cleanUrl = originalUrl;
        if (isEncoded) { try { cleanUrl = decodeURIComponent(originalUrl); } catch(e) {} }
        
        async function attemptLoadTest(url, isProxy = false) {
            return new Promise(resolve => {
                const testAudio = new Audio();
                testAudio.crossOrigin = "anonymous"; 
                testAudio.src = url;
                
                let timeout = setTimeout(() => {
                    testAudio.removeEventListener('canplaythrough', handleSuccess);
                    testAudio.removeEventListener('error', handleError);
                    resolve(false);
                }, 8000); 

                function handleSuccess() {
                    clearTimeout(timeout);
                    resolve(true);
                }

                function handleError(e) {
                    clearTimeout(timeout);
                    console.warn(`Pokus o naƒçten√≠ selhal: ${url}`, e);
                    resolve(false);
                }

                testAudio.addEventListener('canplaythrough', handleSuccess, { once: true });
                testAudio.addEventListener('error', handleError, { once: true });
                testAudio.load();
            });
        }
        
        const isSecureContext = window.location.protocol === 'https:';
        const urlIsHttp = cleanUrl.startsWith('http://');
        let loadedUrl = null;

        if (isSecureContext && urlIsHttp) {
            logStatus('HTTPS str√°nka detekov√°na s HTTP URL. Pou≈æ√≠v√°m rovnou proxy...');
        } else {
            if (await attemptLoadTest(cleanUrl)) { 
                loadedUrl = cleanUrl; 
            }
        }
        
        if (!loadedUrl) {
            logStatus('P≈ô√≠m√© naƒçten√≠ selhalo nebo bylo p≈ôeskoƒçeno. Zkou≈°√≠m proxy...');
            for (const proxyBase of PROXIES) {
                let proxyUrl = proxyBase + (proxyBase.includes('raw?url=') ? encodeURIComponent(cleanUrl) : cleanUrl);
                if (await attemptLoadTest(proxyUrl, true)) { 
                    loadedUrl = proxyUrl; 
                    logStatus('‚úÖ Nalezen funkƒçn√≠ proxy server!');
                    break; 
                }
            }
        }
        
        if (loadedUrl) {
            playlist.push({ name: `[STREAM] ${originalUrl}`, url: loadedUrl });
            updatePlaylistUI();
            savePlaylistToLocal();
            streamUrlInput.value = ''; 
            logStatus(`‚úÖ Extern√≠ URL (Icecast/Stream) p≈ôid√°na do playlistu.`);
            if (currentTrackIndex === -1) { playTrack(playlist.length - 1, 0); }
        } else {
            logStatus('üõë Naƒçten√≠ extern√≠ho streamu selhalo i p≈ôes ve≈ôejn√© proxy. URL streamu je nedostupn√°.');
        }
    });
  </script>
</body>
</html>
