// üî• VYLEP≈†EN√Å: startMediaStream (S OPRAVOU AudioContext a zru≈°en√≠m setTimeout)
function startMediaStream() {
    if (!conn || !conn.open) {
      logStatus('Nelze streamovat, p≈ô√≠jemce nen√≠ p≈ôipojen (DataChannel). ‚úÖ ƒåek√°m na p≈ôipojen√≠...');
      updateSenderControls(false);
      return;
    }
    if (!audioSource.src) {
      logStatus('Nelze streamovat, nen√≠ vybr√°na ≈æ√°dn√° skladba.');
      updateSenderControls(false);
      return;
    }

    try {
        // 1. KONTROLA a Probuzen√≠ AudioContext
        if (!initAudioContext()) return; // Inicializace a prvn√≠ pokus o resume
        
        // üî• Z√°sadn√≠: Opƒõtovn√Ω pokus o resume pro jistotu
        if (audioContext.state !== 'running') {
            audioContext.resume().catch(err => {
                logStatus('AudioContext.resume() selhalo: ' + err.message);
            });
        }
        
        if (audioContext.state !== 'running') {
            logStatus(`üõë Chyba: AudioContext je ${audioContext.state}. Streamov√°n√≠ sel≈æe. Zkuste kliknout Play na stranƒõ Vys√≠laƒçe.`);
            audioSource.pause();
            updateSenderControls(false);
            return;
        }

        // 2. Lok√°ln√≠ p≈ôehr√°v√°n√≠ (mus√≠ se spustit p≈ôed z√≠sk√°n√≠m zdroje)
        // Zastav√≠me, abychom zajistili ƒçist√© spu≈°tƒõn√≠
        audioSource.pause(); 
        
        audioSource.play().catch(err => {
          // Toto se stane, pokud se i tak p≈ôehr√°v√°n√≠ zablokuje, ale AudioContext by mƒõl b√Ωt OK
          logStatus('üõë Lok√°ln√≠ p≈ôehr√°v√°n√≠ audio zablokov√°no. ' + err.message);
          updateSenderControls(false);
          return;
        });

        // 3. Spr√°va Web Audio uzl≈Ø
        // Zaji≈°tƒõn√≠, ≈æe p≈ôedchoz√≠ graf je odpojen
        if (sourceNode) sourceNode.disconnect();
        if (destNode) destNode.disconnect();

        sourceNode = audioContext.createMediaElementSource(audioSource);
        destNode = audioContext.createMediaStreamDestination();

        // P≈ôipojen√≠ zdroje k destinaci MediaStreamu a k reproduktor≈Øm
        sourceNode.connect(destNode);
        sourceNode.connect(audioContext.destination); 

        audioStreamSource = destNode.stream;

        // 4. Spu≈°tƒõn√≠ PeerJS hovoru (MediaCall)
        // Zav≈ôeme p≈ôedchoz√≠ MediaConn, pokud existuje (forceRestart)
        if (mediaConn) {
           mediaConn.close();
           mediaConn = null;
        }
        mediaConn = peerJs.call(conn.peer, audioStreamSource);

        // 5. SDP √∫prava pro vy≈°≈°√≠ bitrate
        mediaConn.on('negotiationneeded', () => {
          const pc = mediaConn.peerConnection;
          if (pc) {
            const originalCreateOffer = pc.createOffer.bind(pc);
            pc.createOffer = function() {
              return originalCreateOffer().then(offer => {
                offer.sdp = modifySdpForOpus96(offer.sdp);
                return offer;
              });
            };
          }
        });

        mediaConn.on('close', stopMediaStream);
        mediaConn.on('error', err => {
          logStatus('Chyba Media Streamu: ' + err);
          stopMediaStream();
        });

        // 6. Odesl√°n√≠ ≈ô√≠d√≠c√≠ zpr√°vy
        sendControlMessage({ type: 'play', currentTime: audioSource.currentTime });
        logStatus('‚úÖ Media stream zah√°jen k p≈ô√≠jemci.');
        updateSenderControls(true);
      } catch (e) {
        logStatus('Chyba p≈ôi startu Web Audio API/Media: ' + e.message);
        audioSource.pause();
        stopMediaStream(false);
      }
    // üî• P≈ÆVODN√ç setTimeout ZDE BYL ZRU≈†EN
}
